<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Regalos de Boda</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
body {
 margin:0;
 background:#fafafa;
 font-family:"Segoe UI", sans-serif;
}

/* Encabezados centrados */
.center {
 text-align:center;
 max-width:500px;
 padding:30px 20px;
 box-sizing:border-box;
 margin:0 auto;
}

.welcome-img {
 width:100%;
 max-width:420px;
 border-radius:20px;
 box-shadow:0 4px 12px rgba(0,0,0,0.2);
}

.hidden { display:none; }

/* --- Grid adaptativo real --- */
.grid-wrapper {
 width:100%;
 padding:20px;
 box-sizing:border-box;
}

.grid {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
 gap: 20px;
}

.card {
 background:white;
 border-radius:14px;
 overflow:hidden;
 cursor:pointer;
 border:3px solid transparent;
 transition:.25s ease;
 box-shadow:0 4px 12px rgba(0,0,0,0.1);
 position: relative; /* Necesario para posicionar el bot贸n de agotado */
}

.card:not(.agotado):hover {
 transform: translateY(-4px);
 box-shadow:0 6px 16px rgba(0,0,0,0.12);
}

.selected {
 border:3px solid #d4af37 !important; /* borde dorado */
 box-shadow:0 6px 18px rgba(212,175,55,0.6) !important;
 transform: scale(1.02);
}

.card img {
 width:100%;
 height:200px;
 object-fit:cover;
}

.card-content { padding:16px; }

/* Nuevo estilo para el bot贸n de Agotado/Ya Elegido */
.agotado-overlay {
 position: absolute;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 display: flex;
 justify-content: center;
 align-items: center;
 background: rgba(255, 255, 255, 0.7);
 z-index: 10;
}

.agotado-btn {
 padding: 8px 15px;
 background: #d4af37; /* Color dorado */
 color: white;
 border-radius: 8px;
 font-weight: bold;
 font-size: 14px;
 text-align: center;
 box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.card:not(.selected).agotado {
 opacity: 0.6; /* Solo aplica opacidad si no est谩 seleccionado */
 pointer-events: none; /* Deshabilita el click si no est谩 seleccionado y est谩 agotado */
}

/* El bot贸n de agotado se muestra solo en tarjetas agotadas */
.card:not(.agotado) .agotado-overlay {
 display: none;
}


/* Bot贸n confirmar */
#confirm-btn {
 display:block;
 margin:25px auto;
 padding:12px 30px;
 background:#0077ff;
 color:white;
 border:none;
 border-radius:12px;
 font-size:18px;
 cursor:pointer;
}
#confirm-btn:disabled {
 background:#aaa;
 cursor:not-allowed;
}

/* Bot贸n Google centrado */
#google-btn-wrapper {
 width:100%;
 display:flex;
 justify-content:center;
 align-items:center;
 margin-top:20px;
}

.g_id_signin > div,
.g_id_signin iframe {
 margin: 0 auto !important;
 display:block !important;
}

/* --- Responsive --- */
@media (max-width: 768px) {
 .card img {
  height:180px;
 }
}

@media (max-width: 480px) {
 .card img {
  height:150px;
 }
 .card-content {
  padding:10px;
 }
 #confirm-btn {
  padding:10px 20px;
  font-size:16px;
 }
}
</style>
</head>

<body>

<div id="welcome" class="center">
 <img class="welcome-img" src="https://raw.githubusercontent.com/Ch3lo94/Regalos_Boda/main/images/IMG-20251127-WA0008.jpg">
 <h2>Nos ayudar铆as mucho con estas cosas que nos faltan わ</h2>
 <p>Ingres谩 con tu cuenta de Google y seleccion谩 lo que desees regalarnos.</p>

 <div id="google-btn-wrapper">
   <div id="g_id_onload"
    data-client_id="342769047778-jc52eh3n59a3vjocagmomi8pln5kbqv3.apps.googleusercontent.com"
    data-callback="handleCredentialResponse">
   </div>

   <div class="g_id_signin"
    data-type="standard"
    data-size="large"
    data-theme="filled_blue">
   </div>
 </div>
</div>

<div id="catalogo" class="hidden">
 <h1 class="center">Eleg铆 un regalo</h1>
 <div class="grid-wrapper">
  <div id="grid" class="grid"></div>
 </div>
 <button id="confirm-btn" disabled>Confirmar selecci贸n</button>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyISWbCW9HkNFs_4tqYFjNrQW6GLU9F-MwytJq1f_ilyB0Y5lF3H7znpV_0CRCWiLSS/exec";

let usuario = null;
let seleccion = [];

// Mostrar mensaje final
function mostrarMensajeFinal() {
 document.body.innerHTML = `
  <div class="center">
   <h1>隆Gracias por tu regalo! </h1>
   <p>Tu respuesta ya qued贸 registrada わ</p>
  </div>`;
}

// Login Google
async function handleCredentialResponse(response) {
 const payload = JSON.parse(atob(response.credential.split('.')[1]));
 usuario = {
  nombre: payload.given_name,
  apellido: payload.family_name,
  email: payload.email.trim().toLowerCase()
 };

 // No es necesario comprobar el localStorage aqu铆, el servidor lo comprueba
 // pero lo mantengo por si acaso.
 if (localStorage.getItem("respondio_" + usuario.email)) {
  mostrarMensajeFinal();
  return;
 }

 const valid = await fetch(API + "?email=" + usuario.email);
 const result = await valid.json();

 if (result.yaRespondio === true) {
  localStorage.setItem("respondio_" + usuario.email, "1");
  mostrarMensajeFinal();
  return;
 }
 
 // Cargar las selecciones previas si existen (aunque el servidor lo borre)
 if (result.seleccionPrevia && Array.isArray(result.seleccionPrevia)) {
  seleccion = result.seleccionPrevia;
 }

 document.getElementById("welcome").classList.add("hidden");
 document.getElementById("catalogo").classList.remove("hidden");
 cargarCatalogo();
}

// Cargar cat谩logo
async function cargarCatalogo() {
 const res = await fetch(API);
 const items = await res.json();
 const grid = document.getElementById("grid");
 grid.innerHTML = "";

 items.forEach(item => {
  const card = document.createElement("div");
  card.className = "card";
  
  // Determinar el texto del bot贸n de agotado
  let agotadoTexto = '';
  if (item.stockRestante <= 0) {
   card.classList.add("agotado");
   agotadoTexto = 'Ya Elegido';
  }

  // Comprobar si fue seleccionado en una sesi贸n anterior (si el backend lo devuelve)
  if (seleccion.includes(item.id)) {
   card.classList.add("selected");
  }

  card.innerHTML = `
   <img src="${item.imagen}">
   <div class="agotado-overlay">
    <span class="agotado-btn">${agotadoTexto}</span>
   </div>
   <div class="card-content">
    <h3>${item.nombre}</h3>
    <p>${item.descripcion || ''}</p>
   </div>
  `;

  card.onclick = () => toggle(item.id, card);
  grid.appendChild(card);
 });
 
 // Actualizar el estado inicial del bot贸n de confirmar
 document.getElementById("confirm-btn").disabled = seleccion.length === 0;
}

// Selecci贸n
function toggle(id, card) {
 // Evita deseleccionar si el 铆tem est谩 agotado, as铆 mantiene el borde dorado
 if (card.classList.contains('agotado') && seleccion.includes(id)) {
  // Si est谩 agotado y seleccionado, no hace nada al clickear.
  return;
 }

 if (seleccion.includes(id)) {
  seleccion = seleccion.filter(x => x !== id);
  card.classList.remove("selected");
 } else {
  // Si el 铆tem no est谩 agotado, permite la selecci贸n
  if (!card.classList.contains('agotado')) {
   seleccion.push(id);
   card.classList.add("selected");
  }
 }
 document.getElementById("confirm-btn").disabled = seleccion.length === 0;
}

// Confirmar selecci贸n
document.getElementById("confirm-btn").onclick = async () => {
 // Filtra elementos que ya est谩n agotados y que no fueron seleccionados originalmente por el usuario
 // Esto es una precauci贸n, ya que la l贸gica de toggle ya deber铆a prevenir esto.
 // Lo ideal es enviar solo lo que el usuario puede elegir (no agotados).
 
 // Filtramos solo las selecciones que tienen stock > 0 si el backend lo permite
 // Dado que el front-end no tiene el stock, enviamos toda la selecci贸n y dejamos que el backend valide.
 
 // Deshabilitamos el bot贸n para evitar m煤ltiples env铆os
 document.getElementById("confirm-btn").disabled = true;

 const resp = await fetch(API, {
  method: "POST",
  headers: {
   'Content-Type': 'application/json'
  },
  body: JSON.stringify({
   nombre: usuario.nombre,
   apellido: usuario.apellido,
   email: usuario.email,
   seleccion // Enviamos la lista de IDs seleccionados
  })
 });

 const r = await resp.json();

 if (r.success) {
  localStorage.setItem("respondio_" + usuario.email, "1");
  mostrarMensajeFinal();
 } else {
  alert("Error al confirmar el regalo: " + (r.error || 'Algo sali贸 mal.'));
  document.getElementById("confirm-btn").disabled = false; // Re-habilita si hay error
 }
};
</script>

</body>
</html>
